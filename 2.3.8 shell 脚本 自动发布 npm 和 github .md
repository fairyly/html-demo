#  shell 脚本 自动发布 npm 和 github 

## npm version使用方法

- 1.version  
>每个npm包都有一个package.json，如果要发布包的话，package.json里面的version字段就是决定发包的版本号了。  
version字段是这样一个结构： ‘0.0.1’，是有三位的版本号。分别是对应的version里面的：major,  minor, patch。  
也就是说当发布大版本的时候会升级为 1.0.0，小版本是0.1.0，一些小修复是0.0.2  

```
npm version [<newversion> | major | minor | patch | premajor | preminor | prepatch | prerelease | from-git]

major：主版本号

minor：次版本号

patch：补丁号

premajor：预备主版本

prepatch：预备次版本

prerelease：预发布版本
```

>假设我们当前版本号为 "0.1.3"，当需要更改次版本号时，使用命令 npm version minor 进行变更。  
此时，该命令会进行两个操作：  
更改 package.json 中version，将版本信息有 "0.1.3"更改为 "0.2.0"  
保存修改并生产一个新的commit  

>若需要指定commit 的信息，可以使用 -m 命令  
```
npm version patch -m "Upgrade to %s"  # %s 会自动替换成版本号
```

npm version |    功能
--          |    --|
major       |   如果没有预发布号，则直接升级一位大号，其他位都置为0- 如果有预发布号： -- 中号和小号都为0，则不升级大号，而将预发布号删掉。即2.0.0-1变成2.0.0，这就是预发布的作用  -- 如果中号和小号有任意一个不是0，那边会升级一位大号，其他位都置为0，清空预发布号。即 2.0.1-0变成3.0.0
minor       |      如果没有预发布号，则升级一位中号，大号不动，小号置为空 - 如果有预发布号:  -- 如果小号为0，则不升级中号，将预发布号去掉  -- 如果小号不为0，同理没有预发布号
patch        |      如果没有预发布号：直接升级小号，去掉预发布号 - 如果有预发布号：去掉预发布号，其他不动
premajor     |      直接升级大号，中号和小号置为0，增加预发布号为0
preminor     |       直接升级中号，小号置为0，增加预发布号为0
prepatch     |       直接升级小号，增加预发布号为0
prerelease   |       如果没有预发布号：增加小号，增加预发布号为0  - 如果有预发布号，则升级预发布号



参考： https://www.jianshu.com/p/5565536a1f82

## git tag 打一个版本 tag

- 添加附注 tag
```
git tag -a  <tag名> -m <注释文字>
```

- 一次推送本地所有 tags，使用 --tags选项：
```
git push origin --tags
```

- 删除本地标签
```
git tag -d <标签名>
```

- 删除远端 tag
```
git tag :refs/tags/<tag 名字>
```

## demo

```sh
#!/bin/bash

echo "Select a option to release (input a serial number)："
echo

select VERSION in patch minor major "Specific Version"
  do
    echo
    if [[ $REPLY =~ ^[1-4]$ ]]; then
      if [[ $REPLY == 4 ]]; then
        read -p "Enter a specific version: " -r VERSION
        echo
        if [[ -z $REPLY ]]; then
          VERSION=$REPLY
        fi
      fi

      read -p "Release $VERSION - are you sure? (y/n) " -n 1 -r
      echo

      if [[ $REPLY =~ ^[Yy]$ || -z $REPLY ]]; then
        # pre release task
        npm run lint
        npm run test

        # bump version
        npm version $VERSION
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo Releasing ${NEW_VERSION} ...

        # npm release
        npm whoami
        npm publish
        echo "✅ Released to npm."

        # github release
        git add CHANGELOG.md
        git commit -m "chore: changelog"
        git push
        git push origin refs/tags/v${NEW_VERSION}
        echo "✅ Released to Github."
      else
        echo Cancelled
      fi
      break
    else
      echo Invalid \"${REPLY}\"
      echo "To continue, please input a serial number(1-4) of an option."
      echo
    fi
  done
```

- 执行
```
bash release.sh

or

# package.json 配置 release
"scripts": {
    "release": "/bin/bash scripts/release.sh"
  },
```

## 参考
- [vuepress](https://github.com/vuejs/vuepress/blob/0.x/package.json)
- [npm-version](https://docs.npmjs.com/cli/version)
- [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)
