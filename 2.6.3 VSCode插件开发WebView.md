# 2.6.3 VSCode插件开发WebView


### 3.1. 创建WebView

```
context.subscriptions.push(vscode.commands.registerCommand('extension.demo.openWebview', function (uri) {
	// 创建webview
	const panel = vscode.window.createWebviewPanel(
		'testWebview', // viewType
		"WebView演示", // 视图标题
		vscode.ViewColumn.One, // 显示在编辑器的哪个部位
		{
			enableScripts: true, // 启用JS，默认禁用
			retainContextWhenHidden: true, // webview被隐藏时保持状态，避免被重置
		}
	);
	panel.webview.html = `<html><body>你好，我是Webview</body></html>`
```
>
- 默认情况下，在Web视图中禁用JavaScript，但可以通过传入`enableScripts: true`选项轻松启用；
- 默认情况下当webview被隐藏时资源会被销毁，通过`retainContextWhenHidden: true`会一直保存，但会占用较大内存开销，仅在需要时开启；



### 3.2. 加载本地资源
>出于安全考虑，Webview默认无法直接访问本地资源，它在一个孤立的上下文中运行，想要加载本地图片、js、css等必须通过特殊的vscode-resource:协议，网页里面所有的静态资源都要转换成这种格式，否则无法被正常加载。

>`vscode-resource:`协议类似于`file:`协议，但它只允许访问特定的本地文件。和`file:`一样，`vscode-resource:`从磁盘加载绝对路径的资源。

封装了一个转换方法：
```
/**
 * 获取某个扩展文件相对于webview需要的一种特殊路径格式
 * 形如：vscode-resource:/Users/toonces/projects/vscode-cat-coding/media/cat.gif
 * @param context 上下文
 * @param relativePath 扩展中某个文件相对于根目录的路径，如 images/test.jpg
 */
getExtensionFileVscodeResource: function(context, relativePath) {
	const diskPath = vscode.Uri.file(path.join(context.extensionPath, relativePath));
	return diskPath.with({ scheme: 'vscode-resource' }).toString();
}
```
默认情况下，vscode-resource:只能访问以下位置中的资源：

- 扩展程序安装目录中的文件。
- 用户当前活动的工作区内。
- 当然，你还可以使用dataURI直接在Webview中嵌入资源，这种方式没有限制；


### 3.3. 从文件加载HTML内容
默认不支持从文件加载HTML，需要自己封装代码,简单封装了一个供大家参考：

```
/**
 * 从某个HTML文件读取能被Webview加载的HTML内容
 * @param {*} context 上下文
 * @param {*} templatePath 相对于插件根目录的html文件相对路径
 */
function getWebViewContent(context, templatePath) {
	const resourcePath = path.join(context.extensionPath, templatePath);
	const dirPath = path.dirname(resourcePath);
	let html = fs.readFileSync(resourcePath, 'utf-8');
	// vscode不支持直接加载本地资源，需要替换成其专有路径格式，这里只是简单的将样式和JS的路径替换
	html = html.replace(/(<link.+?href="|<script.+?src="|<img.+?src=")(.+?)"/g, (m, $1, $2) => {
		return $1 + vscode.Uri.file(path.resolve(dirPath, $2)).with({ scheme: 'vscode-resource' }).toString() + '"';
	});
	return html;
}
```
>运行这段代码之后，会自动将HTML文件中link、href、script、img的资源相对路径全部替换成正确的vscode-resource:绝对路径，例如：
```
../../lib/vue-2.5.17/vue.js
变成
vscode-resource:/Users/test/workspace/vscode-plugin-demo/lib/vue-2.5.17/vue.js
```

使用方法如下：

```
panel.webview.html = getWebViewContent(context, 'src/view/test-webview.html');
```

## 3.4. 消息通信
>Webview和普通网页非常类似，不能直接调用任何VSCodeAPI，但是，
它唯一特别之处就在于多了一个名叫acquireVsCodeApi的方法，执行这个方法会返回一个超级阉割版的vscode对象，
这个对象里面有且仅有如下3个可以和插件通信的API：

插件和Webview之间如何互相通信呢？

- 插件给Webview发送消息（支持发送任意可以被JSON化的数据）：
```
panel.webview.postMessage({text: '你好，我是小茗同学！'});
```

- Webview端接收：
```
window.addEventListener('message', event => {
	const message = event.data;
	console.log('Webview接收到的消息：', message);
}
```

---------------

- Webview主动发送消息给插件：
```
vscode.postMessage({text: '你好，我是Webview啊！'});
```

- 插件接收：

```
panel.webview.onDidReceiveMessage(message => {
	console.log('插件收到的消息：', message);
}, undefined, context.subscriptions);
```


## 参考
- [extensions/webview](https://code.visualstudio.com/docs/extensions/webview)
- [VSCode插件开发全攻略（七）WebView](http://blog.haoji.me/vscode-plugin-webview.html)
