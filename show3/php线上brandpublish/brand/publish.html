<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>微友</title>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/brand/css/publish.css"/>
<link href="http://weiyoustyle.oss-cn-hangzhou.aliyuncs.com/css/style.css" rel="stylesheet" />
<link href="__PUBLIC__/nav/iconfont.css"  rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/brand/css/weui1.1.min.css"/>
<script src="http://weiyounew.oss-cn-hangzhou.aliyuncs.com/js/jquery.js"></script>
<script src="http://weiyoustyle.oss-cn-hangzhou.aliyuncs.com/js/main.js"></script>
<script type="text/javascript" src="__PUBLIC__/brand/js/weui.min.js"></script>
<style>
    .img-select div.weui-uploader__bd{
        width: 78%;
    }
    .weui-uploader__file{
        width: 45px;
        height: 45px;
    }
</style>
</head>
<body>
	<div class="header">
        <a href="javascript:history.back()">
            
        </a><a>
            货源发布
        </a><a>
            
        </a>
    </div>
    <div class="publish-tit">
        <div class="publish-titpic">
            <img src="__PUBLIC__/brand/images/brand-tit.png" alt="tit"/>
            <p>货源发布</p>
        </div>
    </div>
    <div class="publish-form">
       
        <form class="publish-formcon">
            <div class="form-tit">
                <p>产品名称:</p>
            </div>
            <div class="form-text item">
                <input class="form-proname" placeholder="请输入产品名称"  required/>
            </div>
            <div class="form-tit">
                <p>品牌介绍:</p>
            </div>
            <div class="form-text item">
                <textarea class="form-pdetail" placeholder="请输入内容" name="" rows="5" required></textarea>
                <div class="audio-select">
                    <img src="__PUBLIC__/brand/images/pic-audio.png" alt="audio"/>
                </div>
            </div>
            <div class="img-select item">
                <div class="img-show">
                    <img src="__PUBLIC__/brand/images/pic-thumb.png" alt="imgshow"/>
                </div>
                <!-- <div class="img-up">
                    <input class="up-pic" type="file" capture="camera" accept="image/*,capture=camera" file-upload=""/>
                    <img src="__PUBLIC__/brand/images/pic-up.png" alt="pic-up"/>
                </div> -->
                <input type="hidden" name="status" id="status" value="0">
                <div class="weui-uploader__bd" id="uploaderCustom">
                    <ul class="weui-uploader__files" id="uploaderCustomFiles"></ul>
                    <div class="weui-uploader__input-box">
                        <input id="uploaderCustomInput" class="weui-uploader__input" type="file" accept="image/*" multiple="">
                    </div>
                </div>
            </div>
            <div class="form-space item"></div>
            <div class="form-qrcode">
                <div class="qrcode-btn">
                    <button class="up-qrcode">上传二维码</button>
                    <!-- <input class="up-qrcode" type="file" capture="camera" accept="image/*,capture=camera" file-upload=""/> -->
                </div>
                <div class="qrcode-pic">
                    <img src="__PUBLIC__/brand/images/qrcode.jpg" alt="qrcode"/>
                </div>
            </div>
            <div class="form-sub">
                <a href="javascript:;" class="brand-formsub">
                        发布
                </a>
            </div>
        </form>
        <form id="infos" action="{:U('brand/upload')}" method="post" data-ajax="false" method="post" enctype="multipart/form-data" style="display:none;">
                <input type="file" name="img" id="img" style="display:none;">
                <input name="types" id="types" style="display:none;" value="{$status}">
        </form>
    </div>
    <div class="publish-note">
        <div class="publish-notecon">
            <h3>须知</h3>
            <p>1、请如实填写关于货源的有关信息。</p>
            <p>2、提交成功后请记住你的代理号，以便您查询受理情况。</p>
            <p>3、我们将会安排工作人员在24小时内与你联系，请保持手机畅通</p>
        </div>
    </div>
    <div class="popup-container popup-showing active">
        <div class="popup">
            <div class="popup-head">
                <h3 class="popup-title ng-binding">开始录音!</h3>
            </div>
            <div class="popup-body">
                <div class="popup popup-record-voice" style="margin-top:0px;">
                    <p><img src="__PUBLIC__/brand/images/wx-recording.gif"/></p>
                    <p class="balanced center">00：<span class="time-seconds">60</span></p> 
                </div>
            </div>
            <div class="popup-buttons">
                <button class="button button-default">以后再说</button>
                <button class="button button-balanced">说完了</button>
            </div>
        </div>
    </div>
    <div style="display: none;" class="updiolog">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title"></strong></div>
            <div class="weui-dialog__bd"></div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary upclose">确定</a>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="__PUBLIC__/brand/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript">
     $(function(){
        $.ajax({  
            type : "POST",  
            url : '', 
            success : function(data){  
                // console.log(data);
                wx.config({
                    debug: false,
                    appId: 'wxc5184614dbf459cb',
                    timestamp: 1483760657,
                    nonceStr: '',
                    signature: '',
                    jsApiList: [
                      'startRecord',
                      'stopRecord',
                      'onVoiceRecordEnd',
                      'translateVoice'
                    ]
                });
                wx.ready(function () {
                });
            }  
        });      
     });
    </script>   
    <script type="text/javascript">
        var localId;
        var r;
        $(".audio-select").click(function(){
            $(".popup-container").fadeIn();
            var s=$(".time-seconds").text();
            r=setInterval(redu,1000);
            function redu(){
                s--;
                if (s<0) {
                    clearInterval(r);
                    s=0;
                };
                $(".time-seconds").text(s);
            }
            wx.startRecord();
            wx.onVoiceRecordEnd({
            // 录音时间超过一分钟没有停止的时候会执行 complete 回调
                complete: function (res) {
                    localId = res.localId; 
                    console.log(localId );
                }
            });
        });
        $(".button-default").click(function(){
            $(".popup-container").fadeOut();
            clearInterval(r);
            $(".time-seconds").html(60);
        });
        $(".button-balanced").click(function(){
            wx.stopRecord({
                success: function (res) {
                    localId = res.localId;
                    console.log(localId);
                }
            });
            wx.translateVoice({
                localId: 'localId', // 需要识别的音频的本地Id，由录音相关接口获得
                isShowProgressTips: 1, // 默认为1，显示进度提示
                success: function (res) {
                    alert(res.translateResult); // 语音识别的结果
                }
            });
            // $(".popup-container").fadeOut();
        });
    </script> 
    <script>
        /* 图片上传 */
        var uploadCustomFileList = [];
        var uploadFileName=[];
        var uploadCount=0;
        // 这里是简单的调用，其余api请参考文档
        weui.uploader('#uploaderCustom', {
            url: '{:U("brand/ajax_upload_imgs")}',
            auto: false,
            type:'file',
            onQueued: function onQueued() {
                uploadCustomFileList.push(this);
                $(".img-show").hide();
                this.upload();
            },
            onBeforeQueued: function onBeforeQueued(files) {
                if (["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0) {
                    weui.alert('请上传图片');
                    return false;
                }
                if (this.size > 500* 1024) {
                    weui.alert('请上传不超过500KB的图片');
                    return false;
                }
                if (files.length > 3) {
                    // 防止一下子选中过多文件
                    weui.alert('最多只能上传3张图片，请重新选择');
                    return false;
                }
                if (uploadCount + 1 > 3) {
                    weui.alert('最多只能上传3张图片');
                    return false;
                }

                ++uploadCount;
            },
             onSuccess: function (ret) {
               console.log(this, ret);
               var upfilename=eval('(' + this.xhr.response+ ')');
               uploadFileName.push(upfilename.data);
               // return true; // 阻止默认行为，不使用默认的成功态
            },
            onError: function(err){
               // console.log(this, err);
               var upfilename=eval('(' + this.xhr.response+ ')');
               uploadFileName.push(upfilename.data);
               // console.log(uploadFileName);
               // return true; // 阻止默认行为，不使用默认的失败态
            }
        });
        // 缩略图预览
        document.querySelector('#uploaderCustomFiles').addEventListener('click', function(e){
            var target = e.target;
            while(!target.classList.contains('weui-uploader__file') && target){
                target = target.parentNode;
            }
            if(!target) return;

            var url = target.getAttribute('style') || '';
            var id = target.getAttribute('data-id');

            if(url){
                
                url = url.match(/url\((.*?)\)/)[1];
                console.log(url);
                $('.weui-gallery__img').css('background-image', 'url('+url+')');
            }
            var gallery = weui.gallery(url, {
                onDelete: function(){
                    weui.confirm('确定删除该图片？', function(){
                        var index;
                        for (var i = 0, len = uploadCustomFileList.length; i < len; ++i) {
                            var file = uploadCustomFileList[i];
                            if(file.id == id){
                                index = i;
                                break;
                            }
                        }
                        if(index) uploadCustomFileList.splice(index, 1);
                        uploadFileName.splice(index, 1);
                        uploadCount--;

                        target.remove();
                        gallery.hide();
                    });
                }
            });
        });
       
        var qcode;  
        var status="{$status}"; 
        $('.up-qrcode').click(function(){
            $('#img').click();return false;
        })
        $("#img").change(function(){
            // var reader = new FileReader();
            // reader.onload = function(e){
            //     var dataURL=this.result;
            //     $(".qrcode-pic img").attr("src", dataURL);
            // }
            // reader.readAsDataURL(this.files[0]);
            infosubmit();
            return false;
        });
        function infosubmit(){
            var formData = new FormData($("#infos")[0]);  
            $.ajax({
                type: "POST",
                url: '{:U("brand/upload")}',
                data:formData,
                dataType:'json', 
                async: false,  
                cache: false,  
                contentType: false,  
                processData: false,  
                success: function(result){
                    qcode=result.data;
                    if (result.status==0) {
                        $('.weui-dialog__bd').html(result.msg);
                        $('.updiolog').show();
                    }else{
                        $(".qrcode-pic img").attr("src", qcode);
                    }
                    // console.log(result);
                }
            });
        }
        $('.upclose').click(function(){
            $('.updiolog').hide();
        });
         //建立一个可存取到该file的url
        function getObjectURL(file){
            var url = null; 
            if (window.createObjectURL!=undefined) { // basic
              url = window.createObjectURL(file);
            } else if (window.URL!=undefined) { // mozilla(firefox)
              url = window.URL.createObjectURL(file);
            } else if (window.webkitURL!=undefined) { // webkit or chrome
              url = window.webkitURL.createObjectURL(file);
            }
            return url;
        } 
    </script>
    <!-- 发布 -->
    <script>
        $('.brand-formsub').click(function(){
            var fname=$(".form-proname").val();
            var fdetail=$(".form-pdetail").val();
            if(fname==''|| fdetail==''){return false;};
            var uppics1=uploadFileName[0];
            var uppics2;
            var uppics3;
            if(uploadFileName[1]==undefined){
                uppics2='';
            }else{
                uppics2=uploadFileName[1];
            }
            if(uploadFileName[2]==undefined){
                uppics3='';
            }else{
                uppics3=uploadFileName[2];
            }
            console.log(uppics1);
            $.ajax({  
                type : "POST",  
                url : '{:U("brand/insert")}', 
                data:{fname:fname,fdetail:fdetail,uppics1:uppics1,uppics2:uppics2,uppics3:uppics3,qcode:qcode},
                success : function(data){  
                    console.log(data);
                }  
            });      
        });
    </script>
    <script>

    //统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b568cb6c867797e8aaf3d0759e396fa1";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();  
    </script>

<include file="public:footer" />