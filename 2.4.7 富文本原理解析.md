# 2.4.7 富文本原理解析

## contenteditable 属性

假如我们给一个标签加上 contenteditable="true" 的属性，就像这样：

```
<div contenteditable="true"></div>
```

复制代码那么在这个 `div` 中我们就可以对其进行任意编辑了。  
如果想要插入的子节点不可编辑，我们只需要把子节点的属性设置为 `contenteditable="false"` 即可，就像这样：

## document.execCommand 方法

既然我们可以对上面的 div 随意编辑，那具体怎么编辑呢，目前好像也还是只能输入文本，要怎样才能进行其他操作呢（比如加粗、倾斜、插入图片等等）🤔？  
其实浏览器给我们提供了这样的一个方法 `document.execCommand`，通过它我们就能够操纵上面的可编辑区。具体语法如下：
```
// document.execCommand(命令名称，是否展示用户界面，命令需要的额外参数)
document.execCommand(aCommandName, aShowDefaultUI, aValueArgument)
```
其中第一个参数就是一些命令名称，具体的可以查看 MDN；  
第二个参数写死为 false 就行了，因为早前 IE 有这样一个参数，为了兼容吧，不过这个参数在现代浏览器中是没有影响的；  
第三个参数就是一些命令可能需要额外的参数，比如插入图片就要多传个 url 或 base64 的参数，没有的话传个 null 就行。

我们简要列举下它的几个使用方式，大家就知道怎么用了👇：

```
// 加粗
document.execCommand('bold', false, null);
// 添加图片
document.execCommand('insertImage', false, url || base64);
// 把一段文字用 p 标签包裹起来
document.execCommand('formatblock', false, '<p>');
```

这个命令就是富文本的核心

## Selection 和 Range 对象
我们在执行 `document.execCommand` 这个命令之前首先要知道对谁执行，  
所以这里会有一个选区的概念，也就是` Selection` 对象，它用来表示用户选择的范围或光标位置（光标可以看做是范围重合的特殊状态），一个页面用户可能选择多个范围（比如 `Firefox`）。  
也就是说 `Selection` 包含一个或多个 `Range` 对象（`Selection` 可以说是 `Range` 的集合），当然对于富文本编辑器来说，一般情况下，我们只会有一个选择区域，也就是一个 `Range` 对象，事实上大部分情况也是如此。

所以通常我们可以用 `let range = window.getSelection().getRangeAt(0) `来获取选中的内容信息（`getRangeAt` 接受一个索引值，因为会有多个 `Range`，而现在只有一个，所以写0）。

此外 Selection 对象还有几个常用的方法，addRange、removeAllRanges、collapse 和 collapseToEnd 等等。
这个知识点是很重要的，因为它让我们有了操纵光标的能力


## test 

```
<div class="editor" contenteditable="true">123456</div>

// 段落：这个功能就是把光标所在行的文字用 p 标签包裹起来，
document.execCommand('bold', false, null);

// 加粗
document.execCommand('formatBlock', false, '<p>');

实现列表、水平线、前进、后退功能和加粗是一样的，只需传入不同的命令名即可，就像下面这样：
execCommand(name, args = null) {
  document.execCommand(name, false, args);
}

<button @click="execCommand('insertUnorderedList')">无序列表</button>

<button @click="execCommand('insertHorizontalRule')">水平线</button>

<button @click="execCommand('undo')">后退</button>

<button @click="execCommand('redo')">前进</button>

// 插入链接
document.execCommand('createLink', false, url);

// 插入图片
document.execCommand('insertImage', false, url);
```

>我们执行的是原生的 document.execCommand 方法，浏览器自身会对 contenteditable 这个可编辑区维护一个 undo 栈和一个 redo 栈，  
所以我们才能执行前进和后退的操作，如果我们改写了原生方法，就会破坏原有的栈结构，这时就需要自己去维护

|命名| 说明 |
|-- | --|
backColor | 修改文档的背景颜色。在styleWithCss模式下，则只影响容器元素的背景颜色。这需要一个<color> 类型的字符串值作为参数传入。注意，IE浏览器用这个设置文字的背景颜色。
bold |                    开启或关闭选中文字或插入点的粗体字效果。IE浏览器使用 <strong>标签，而不是<b>标签。
ClearAuthenticationCache|     清除缓存中的所有身份验证凭据。
contentReadOnly|            通过传入一个布尔类型的参数来使能文档内容的可编辑性。(IE浏览器不支持)
copy|        拷贝当前选中内容到剪贴板。启用这个功能的条件因浏览器不同而不同，而且不同时期，其启用条件也不尽相同。使用之前请检查浏览器兼容表，以确定是否可用。
createLink|    将选中内容创建为一个锚链接。这个命令需要一个hrefURI字符串作为参数值传入。URI必须包含至少一个字符，例如一个空格。（浏览器会创建一个空链接）
cut|      剪贴当前选中的文字并复制到剪贴板。启用这个功能的条件因浏览器不同而不同，而且不同时期，其启用条件也不尽相同。使用之前请检查浏览器兼容表，以确定是否可用。
decreaseFontSize|   给选中文字加上 <small> 标签，或在选中点插入该标签。(IE浏览器不支持)
defaultParagraphSeparator|     更改在可编辑文本区域中创建新段落时使用的段落分隔符。有关更多详细信息，请参阅标记生成的差异。
delete|    删除选中部分.
enableAbsolutePositionEditor|    启用或禁用允许移动绝对定位元素的抓取器。Firefox 63 Beta/Dev Edition 默认禁用此功能(bug 1449564)。
enableInlineTableEditing|     启用或禁用表格行和列插入和删除控件。(IE浏览器不支持)
enableObjectResizing|    启用或禁用图像和其他对象的大小可调整大小手柄。(IE浏览器不支持)
fontName|     在插入点或者选中文字部分修改字体名称. 需要提供一个字体名称字符串 (例如："Arial")作为参数。
fontSize|    在插入点或者选中文字部分修改字体大小. 需要提供一个HTML字体尺寸 (1-7) 作为参数。
foreColor  |    在插入点或者选中文字部分修改字体颜色. 需要提供一个颜色值字符串作为参数。
formatBlock | 添加一个HTML块式标签在包含当前选择的行, 如果已经存在了，更换包含该行的块元素 (在 Firefox中, BLOCKQUOTE 是一个例外 -它将包含任何包含块元素). 需要提供一个标签名称字符串作为参数。几乎所有的块样式标签都可以使用`(例如. "H1", "P", "DL", "BLOCKQUOTE"). (IE浏览器仅仅支持标题标签 H1 - H6, ADDRESS, 和 PRE,使用时还必须包含标签分隔符 < >, 例如 "<H1>".)`
forwardDelete  |    删除光标所在位置的字符。 和按下删除键一样。
heading|    添加一个标题标签在光标处或者所选文字上。 需要提供标签名称字符串作为参数 (例如. "H1", "H6"). (IE 和 Safari不支持)
hiliteColor|     更改选择或插入点的背景颜色。需要一个颜色值字符串作为值参数传递。 UseCSS 必须开启此功能。(IE浏览器不支持)
increaseFontSize|     在选择或插入点周围添加一个BIG标签。(IE浏览器不支持)
indent|    缩进选择或插入点所在的行， 在 Firefox 中, 如果选择多行，但是这些行存在不同级别的缩进, 只有缩进最少的行被缩进。
insertBrOnReturn|    控制当按下Enter键时，是插入 br 标签还是把当前块元素变成两个。(IE浏览器不支持)
insertHorizontalRule|    在插入点插入一个水平线（删除选中的部分）
insertHTML|    在插入点插入一个HTML字符串（删除选中的部分）。需要一个个HTML字符串作为参数。(IE浏览器不支持)
insertImage|      在插入点插入一张图片（删除选中的部分）。需要一个 URL 字符串作为参数。这个 URL 图片地址至少包含一个字符。空白字符也可以（IE会创建一个链接其值为null）
insertOrderedList|      在插入点或者选中文字上创建一个有序列表
insertUnorderedList|     在插入点或者选中文字上创建一个无序列表。
insertParagraph|    在选择或当前行周围插入一个段落。(IE会在插入点插入一个段落并删除选中的部分.)
insertText  |     在光标插入位置插入文本内容或者覆盖所选的文本内容。
italic|    在光标插入点开启或关闭斜体字。 (Internet Explorer 使用 EM 标签，而不是 I )
justifyCenter|   对光标插入位置或者所选内容进行文字居中。
justifyFull | 对光标插入位置或者所选内容进行文本对齐。
justifyLeft | 对光标插入位置或者所选内容进行左对齐。
justifyRight |      对光标插入位置或者所选内容进行右对齐。
outdent |      对光标插入行或者所选行内容减少缩进量。
paste |      在光标位置粘贴剪贴板的内容，如果有被选中的内容，会被替换。剪贴板功能必须在 user.js 配置文件中启用。参阅 [1].
redo |      重做被撤销的操作。
removeFormat |      对所选内容去除所有格式
selectAll |      选中编辑区里的全部内容。
strikeThrough |      在光标插入点开启或关闭删除线。
subscript |      在光标插入点开启或关闭下角标。
superscript |       在光标插入点开启或关闭上角标。
underline|   在光标插入点开启或关闭下划线。
undo|    撤销最近执行的命令。
unlink  |    去除所选的锚链接的<a>标签
useCSS  |   切换使用 HTML tags 还是 CSS 来生成标记. 要求一个布尔值 true/false 作为参数。注: 这个属性是逻辑上的倒退 (例如. use false to use CSS, true to use HTML).(IE不支持),该属性已经废弃，使用 styleWithCSS 代替。
styleWithCSS | 用这个取代 useCSS 命令。 参数如预期的那样工作, i.e. true modifies/generates 风格的标记属性, false 生成格式化元素。


## 参考
- [富文本原理了解一下](https://juejin.im/post/5cfe4e8a6fb9a07ec63b09a4)
- [timdown/rangy](https://github.com/timdown/rangy)
- [MDN-execCommand](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand)
